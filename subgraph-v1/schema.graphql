"""
Market represents a deployment of the Voyage protocol
"""
type Market @entity {
  id: ID!
  reserves: [Reserve!]! @derivedFrom(field: "market")
  protocolFee: BigInt!
  protocolTreasury: Bytes!
}

type Reserve @entity {
  id: ID!
  market: Market!
  collection: Bytes!
  currency: Currency!
  configuration: ReserveConfiguration

  totalPrincipal: BigInt!
  totalInterest: BigInt!
  totalBorrow: BigInt!
  totalLiquidity: BigInt!
  liquidityRatio: BigInt!
  utilizationRate: BigInt!

  borrowRate: BigInt!
  depositRate: BigInt!

  seniorTrancheVToken: VToken!
  seniorTrancheLiquidity: BigInt!
  seniorTrancheDepositRate: BigInt!

  juniorTrancheVToken: VToken!
  juniorTrancheLiquidity: BigInt!
  juniorTrancheDepositRate: BigInt!
}

type ReserveConfiguration @entity {
  id: ID!
  reserve: Reserve!
  isInitialized: Boolean!
  isActive: Boolean!
  incomeRatio: BigInt!
  loanInterval: BigInt!
  loanTenure: BigInt!
  gracePeriod: BigInt!
  liquidationBonus: BigInt!
}

type Currency @entity(immutable: true) {
  id: ID! # id is the address of the currency
  symbol: String!
  decimals: BigInt!
}

type VToken @entity {
  id: ID! # address of Junior/Senior deposit token
  reserve: Reserve!
  tranche: Tranche!
  asset: Currency!
  totalAssets: BigInt!
  totalShares: BigInt!
}

type UserData @entity {
  id: ID!
  deposits: [UserDepositData!]! @derivedFrom(field: "user")
  unbonding: [UserUnbondingData!]! @derivedFrom(field: "user")
  vault: Vault # a user may only be a depositor. vault is optional.
}

type UserDepositData @entity {
  """
  user address + collection address
  """
  id: ID!
  user: UserData!
  collection: Bytes!
  # The **current** shares held by the user. Used to compute current holdings (maxWithdraw)
  juniorTrancheShares: BigInt!
  # The cumulative deposits (in assets) as emitted in the Deposit event. Used for PnL.
  juniorTrancheCumulativeDeposits: BigInt!
  # The cumulative withdrawals (in assets) as emitted in the Withdraw event. Used for PnL.
  juniorTrancheCumulativeWithdrawals: BigInt!
  # The **current** shares held by the user. Used to compute current holdings (maxWithdraw)
  seniorTrancheShares: BigInt!
  # The cumulative deposits (in assets) as emitted in the Deposit event. Used for PnL.
  seniorTrancheCumulativeDeposits: BigInt!
  # The cumulative withdrawals (in assets) as emitted in the Claim event. Used for PnL.
  seniorTrancheCumulativeWithdrawals: BigInt!
}

type UserUnbondingData @entity {
  """
  user address + collection address
  """
  id: ID!
  time: BigInt!
  collection: Bytes!
  blocknum: BigInt!
  shares: BigInt!
  maxUnderlying: BigInt!
  user: UserData!
}

enum Tranche {
  Senior
  Junior
}

type Vault @entity {
  id: ID!
  user: UserData!
  creditLines: [CreditLine!]! @derivedFrom(field: "vault")
  loans: [Loan!]! @derivedFrom(field: "vault")
}

type CreditLine @entity {
  id: ID! # concat(vault address, underlying asset)
  vault: Vault!
  reserve: Reserve!
  marginEscrow: Bytes!
  creditEscrow: Bytes!
  borrowRate: BigInt! # weighted average, updated on every borrow and final repayment
  totalDebt: BigInt!
  totalMargin: BigInt!
  marginRequirement: BigInt!
  withdrawableSecurityDeposit: BigInt!
  creditLimit: BigInt!
  spendableBalance: BigInt!
  gav: BigInt!
  ltv: BigInt!
  healthFactor: BigInt!
}

type Loan @entity {
  """
  vault + collection + loan id
  """
  id: ID!
  reserve: Reserve!
  vault: Vault!
  loanId: BigInt!
  tokenId: BigInt!

  principal: BigInt!
  interest: BigInt!
  pmt_principal: BigInt!
  pmt_interest: BigInt!
  pmt_payment: BigInt!

  term: BigInt!
  epoch: BigInt!
  nper: BigInt!
  apr: BigInt!

  timestamp: BigInt!
  nextPaymentDue: BigInt!

  totalPrincipalPaid: BigInt!
  totalInterestPaid: BigInt!
  paidTimes: BigInt!
  repayments: [Repayment!]! @derivedFrom(field: "loan")
  liquidations: [Liquidation!]! @derivedFrom(field: "loan")
}

type Repayment @entity {
  id: ID! # concat(vault address, underlying asset, loan id, repayment index)
  loan: Loan!
  principal: BigInt!
  interest: BigInt!
  total: BigInt!
  paidAt: BigInt!
  repaid: Boolean!
  isLiquidated: Boolean!
  liquidation: Liquidation!
}

type Liquidation @entity {
  id: ID! # same as Repayment.id
  liquidator: String! # address of user
  vault: Vault!
  reserve: Reserve!
  loanId: BigInt! # id in sc's
  repaymentId: BigInt! # id in sc's
  loan: Loan!
  repayment: Repayment!
  totalDebt: BigInt!
  amountToWriteDown: BigInt!
}
